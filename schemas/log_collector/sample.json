{
  "$schema": "log-collector.schema.json",
  "kind": "log_collector",
  "flavor": "loki",
  "version": "latest",
  "lifecycle": "ENVIRONMENT_BOOTSTRAP",
  "disabled": true,
  "provided": false,
  "depends_on": [],
  "metadata": {
    "name": "loki-log-collector"
  },
  "spec": {
    "retentation_days": 7,
    "storage_size": "5Gi",
    "namespace": "log-collector-test"
  },
  "advanced": {
    "k8s": {
      "log_collector": {
        "loki": {
          "loki": {
            "structuredConfig": {
              "server": {
                "http_server_read_timeout": "310s",
                "http_server_write_timeout": "310s",
                "http_server_idle_timeout": "300s"
              },
              "ingester": {
                "chunk_target_size": 1572864,
                "chunk_encoding": "snappy",
                "max_chunk_age": "2h",
                "chunk_idle_period": "2h"
              },
              "schema_config": {
                "configs": [
                  {
                    "from": "2022-06-21",
                    "store": "boltdb-shipper",
                    "object_store": "s3",
                    "schema": "v12",
                    "index": {
                      "prefix": "index_",
                      "period": "24h"
                    }
                  }
                ]
              },
              "compactor": {
                "working_directory": "/data/compactor",
                "shared_store": "s3",
                "compaction_interval": "10m"
              },
              "querier": {
                "query_timeout": "300s",
                "engine": {
                  "timeout": "300s"
                }
              },
              "ingester_client": {
                "grpc_client_config": {
                  "max_recv_msg_size": 104857600
                }
              },
              "limits_config": {
                "max_global_streams_per_user": 5000,
                "split_queries_by_interval": "15m",
                "max_query_parallelism": 32
              }
            }
          },
          "distributor": {
            "replicas": 1,
            "autoscaling": {
              "enabled": true,
              "minReplicas": 1,
              "maxReplicas": 5,
              "targetCPUUtilizationPercentage": 60,
              "targetMemoryUtilizationPercentage": 80
            },
            "extraEnv": [
              {
                "name": "MY_POD_IP",
                "valueFrom": {
                  "fieldRef": {
                    "fieldPath": "status.podIP"
                  }
                }
              }
            ],
            "extraArgs": [
              "-memberlist.bind-addr=$(MY_POD_IP)"
            ]
          },
          "ingester": {
            "replicas": 1,
            "persistence": {
              "enabled": true,
              "size": "5Gi"
            },
            "extraEnv": [
              {
                "name": "MY_POD_IP",
                "valueFrom": {
                  "fieldRef": {
                    "fieldPath": "status.podIP"
                  }
                }
              }
            ],
            "extraArgs": [
              "-memberlist.bind-addr=$(MY_POD_IP)"
            ]
          },
          "querier": {
            "replicas": 1,
            "persistence": {
              "enabled": true,
              "size": "5Gi"
            },
            "autoscaling": {
              "enabled": true,
              "minReplicas": 1,
              "maxReplicas": 10,
              "targetCPUUtilizationPercentage": 60,
              "targetMemoryUtilizationPercentage": 80
            },
            "extraEnv": [
              {
                "name": "MY_POD_IP",
                "valueFrom": {
                  "fieldRef": {
                    "fieldPath": "status.podIP"
                  }
                }
              }
            ],
            "extraArgs": [
              "-memberlist.bind-addr=$(MY_POD_IP)"
            ]
          },
          "queryFrontend": {
            "replicas": 1,
            "autoscaling": {
              "enabled": true,
              "minReplicas": 1,
              "maxReplicas": 5,
              "targetCPUUtilizationPercentage": 60,
              "targetMemoryUtilizationPercentage": 80
            }
          }
        },
        "minio": {
          "provisioning": {
            "extraCommands": [
              "mc ilm ls provisioning/loki --json"
            ]
          }
        },
        "promtail": {
          "config": {
            "snippets": {
              "pipelineStages": [
                {
                  "docker": {}
                },
                {
                  "match": {
                    "selector": "{app=\"control-plane-new\"}",
                    "stages": [
                      {
                        "multiline": {
                          "firstline": "\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2},\\d{3} [A-Z]+",
                          "max_wait_time": "2s"
                        }
                      }
                    ]
                  }
                }
              ]
            }
          }
        }
      }
    }
  },
  "out": {}
}
