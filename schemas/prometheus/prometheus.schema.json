{
  "$schema": "http://json-schema.org/draft-04/schema#",
  "type": "object",
  "description": "Schema for Prometheus",
  "allOf": [
    {
      "$ref": "../../traits/base.schema.json"
    },
    {
      "$ref": "#/$defs/specDef"
    },
    {
      "$ref": "#/$defs/advancedDef"
    },
    {
      "type": "object",
      "properties": {
        "flavor": {
          "type": "string",
          "description": "Implementation selector for the resource. e.g. for a resource type ingress, default, aws_alb, gcp_alb etc.",
          "enum": ["default", "victoria_metrics"]
        }
      }
    }
  ],
  "required": [
    "kind",
    "version",
    "metadata",
    "spec"
  ],
  "$defs": {
    "specDef": {
      "type": "object",
      "properties": {
        "spec": {
          "type": "object",
          "additionalProperties": false,
          "required": ["alertmanager", "grafana", "pushgateway", "prometheus"],        
          "properties": {
            "mode": {
              "type": "string",
              "description": "if the flavor is victoria_metrics, you can choose your mode of installation. either standalone or cluster",
              "enum": [
                "cluster", "standalone"
              ],
              "default": "standalone"
            },
            "diskSize": {
              "type": "string",
              "description": "Size of the prometheus PV"
            },
            "alertmanager": {
              "type": "object",
              "description": "Alertmanager specifications",
              "properties": {
                "size": {
                  "type": "object",
                  "description": "Size of alertmanager pod",
                  "allOf": [
                    {
                      "type": "object",
                      "$ref": "../../traits/size-k8s.schema.json"
                    }
                  ]
                },
                "receivers": {
                  "type": "object",
                  "description": "Receivers for alertmanager",
                  "patternProperties": {
                    ".*": {
                      "type": "object",
                      "properties": {
                        "url": { "type": "string" },
                        "send_resolved": { "type": "bool" }
                      }
                    }
                  }
                }
              }
            },
            "grafana": {
              "type": "object",
              "description": "Grafana specifications",
              "properties": {
                "size": {
                  "type": "object",
                  "description": "Size of alertmanager pod",
                  "allOf": [
                    {
                      "type": "object",
                      "$ref": "../../traits/size-k8s.schema.json"
                    }
                  ]
                },
                "additionalDataSources": {
                  "type": "object",
                  "description": "Additional data sources",
                  "patternProperties": {
                    ".*": {
                      "type": "object",
                      "properties": {
                        "name": { "type": "string" },
                        "access": { "type": "string" },
                        "editable": { "type": "bool" },
                        "jsonData": { "type": "object" },
                        "orgId": { "type": "integer" },
                        "type": { "type": "string" },
                        "url": { "type": "string" },
                        "version": { "type": "integer" }
                      }
                    }
                  }
                }
              }
            },
            "prometheus": {
              "type": "object",
              "description": "Prometheus specifications",
              "properties": {
                "enabled": {
                  "type": "boolean",
                  "description": "you want prometheus to be enabled/disabled",
                  "default": true
                },
                "size": {
                  "type": "object",
                  "description": "Size of alertmanager pod",
                  "allOf": [
                    {
                      "type": "object",
                      "$ref": "../../traits/size-k8s.schema.json"
                    }
                  ]
                }
              }
            },
            "vmsingle": {
              "type": "object",
              "description": "vmsingle specifications",
              "properties": {
                "size": {
                  "type": "object",
                  "description": "Size of vmsingle pod",
                  "allOf": [
                    {
                      "type": "object",
                      "$ref": "../../traits/size-k8s.schema.json"
                    }
                  ]
                }
              }
            },
            "vmalert": {
              "type": "object",
              "description": "vmalert specifications",
              "properties": {
                "size": {
                  "type": "object",
                  "description": "Size of vmalert pod",
                  "allOf": [
                    {
                      "type": "object",
                      "$ref": "../../traits/size-k8s.schema.json"
                    }
                  ]
                }
              }
            },
            "vmselect": {
              "type": "object",
              "description": "vmselect specifications",
              "properties": {
                "size": {
                  "type": "object",
                  "description": "Size of vmselect pod",
                  "allOf": [
                    {
                      "type": "object",
                      "$ref": "../../traits/size-k8s.schema.json"
                    }
                  ]
                }
              }
            },
            "vmstorage": {
              "type": "object",
              "description": "vmstorage specifications",
              "properties": {
                "size": {
                  "type": "object",
                  "description": "Size of vmstorage pod",
                  "allOf": [
                    {
                      "type": "object",
                      "$ref": "../../traits/size-k8s.schema.json"
                    }
                  ]
                }
              }
            },
            "vminsert": {
              "type": "object",
              "description": "vminsert specifications",
              "properties": {
                "size": {
                  "type": "object",
                  "description": "Size of vminsert pod",
                  "allOf": [
                    {
                      "type": "object",
                      "$ref": "../../traits/size-k8s.schema.json"
                    }
                  ]
                }
              }
            },
            "vmagent": {
              "type": "object",
              "description": "vmalert specifications",
              "properties": {
                "size": {
                  "type": "object",
                  "description": "Size of vmagent pod",
                  "allOf": [
                    {
                      "type": "object",
                      "$ref": "../../traits/size-k8s.schema.json"
                    }
                  ]
                }
              }
            },
            "prometheus-operator": {
              "type": "object",
              "description": "Prometheus Operator specifications",
              "properties": {
                "size": {
                  "type": "object",
                  "description": "Size of alertmanager pod",
                  "allOf": [
                    {
                      "type": "object",
                      "$ref": "../../traits/size-k8s.schema.json"
                    }
                  ]
                }
              }
            },
            "pushgateway": {
              "type": "object",
              "description": "Pushgateway specifications",
              "properties": {
                "size": {
                  "type": "object",
                  "description": "Size of alertmanager pod",
                  "allOf": [
                    {
                      "type": "object",
                      "$ref": "../../traits/size-k8s.schema.json"
                    }
                  ]
                }
              }
            }
          }
        }
      }
    },
    "advancedDef": {
      "type": "object",
      "properties": {
        "advanced": {
          "type": "object",
          "description": "Advanced block of the Prometheus configuration",
          "properties": {
            "enable_migration": {
              "type": "boolean",
              "description": "Enable if you want to migrate existing prometheus data to victoria_metrics. this should be only enabled when flavor is victoria_metrics",
              "default": false
            },
            "enable_host_anti_affinty": {
              "type": "boolean",
              "description": "Enable if you want to spread victoria metrics pods across different nodes, should only be enabled when flavor is victoria_metrics and mode is cluster",
              "default": false
            },
            "kube-prometheus-stack": {
              "type": "object",
              "description": "Advanced values of kube-prometheus-stack",
              "properties": {
                "values": {
                  "type": "object",
                  "description": "Helm values as per the helm chart https://artifacthub.io/packages/helm/prometheus-community/kube-prometheus-stack"
                }
              }
            },
            "victoria-metrics-k8s-stack": {
              "type": "object",
              "description": "Advanced values of victoria-metrics-k8s-stack",
              "properties": {
                "values": {
                  "type": "object",
                  "description": "Helm values as per the helm chart https://github.com/VictoriaMetrics/helm-charts/blob/master/charts/victoria-metrics-k8s-stack/values.yaml"
                }
              }
            },
            "pushgateway": {
              "type": "object",
              "description": "Advanced values of pushgateway",
              "properties": {
                "values": {
                  "type": "object",
                  "description": "Helm values as per the helm chart https://artifacthub.io/packages/helm/prometheus-community/prometheus-pushgateway"
                }
              }
            }
          }
        }
      }
    }
  }
}